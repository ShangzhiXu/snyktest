--- /home/V1SCAN/CWE-122/FormattedVul/OLD##CVE-2018-8800##0##rdesktop@@rdesktop##seamless.c	2023-12-12 03:51:30.130026361 +0900
+++ /home/V1SCAN/CWE-122/FormattedPatch/NEW##CVE-2018-8800##0##rdesktop@@rdesktop##seamless.c	2023-12-12 03:51:30.410024731 +0900
@@ -152,6 +152,12 @@
 
       icon_buf[len] = strtol(byte, NULL, 16);
       len++;
+
+      if ((size_t)len >= sizeof(icon_buf)) {
+        logger(Protocol, Warning,
+               "seamless_process_line(), icon data would overrun icon_buf");
+        break;
+      }
     }
 
     ui_seamless_seticon(id, tok5, width, height, chunk, icon_buf, len);
@@ -323,6 +329,12 @@
 static void seamless_process(STREAM s) {
   unsigned int pkglen;
   char *buf;
+  struct stream packet = *s;
+
+  if (!s_check(s)) {
+    rdp_protocol_error("seamless_process(), stream is in unstable state",
+                       &packet);
+  }
 
   pkglen = s->end - s->p;
   /* str_handle_lines requires null terminated strings */
