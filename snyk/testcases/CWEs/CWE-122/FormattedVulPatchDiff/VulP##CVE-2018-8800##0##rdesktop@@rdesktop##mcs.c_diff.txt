--- /home/V1SCAN/CWE-122/FormattedVul/OLD##CVE-2018-8800##0##rdesktop@@rdesktop##mcs.c	2023-12-12 03:51:30.030026945 +0900
+++ /home/V1SCAN/CWE-122/FormattedPatch/NEW##CVE-2018-8800##0##rdesktop@@rdesktop##mcs.c	2023-12-12 03:51:30.320025255 +0900
@@ -41,9 +41,17 @@
 
 /* Parse a DOMAIN_PARAMS structure (ASN.1 BER) */
 static RD_BOOL mcs_parse_domain_params(STREAM s) {
-  int length;
+  uint32 length;
+  struct stream packet = *s;
 
   ber_parse_header(s, MCS_TAG_DOMAIN_PARAMS, &length);
+
+  if (!s_check_rem(s, length)) {
+    rdp_protocol_error("mcs_parse_domain_params(), consume domain params from "
+                       "stream would overrun",
+                       &packet);
+  }
+
   in_uint8s(s, length);
 
   return s_check(s);
@@ -81,8 +89,9 @@
 static RD_BOOL mcs_recv_connect_response(STREAM mcs_data) {
   UNUSED(mcs_data);
   uint8 result;
-  int length;
+  uint32 length;
   STREAM s;
+  struct stream packet;
   RD_BOOL is_fastpath;
   uint8 fastpath_hdr;
 
@@ -92,6 +101,8 @@
   if (s == NULL)
     return False;
 
+  packet = *s;
+
   ber_parse_header(s, MCS_CONNECT_RESPONSE, &length);
 
   ber_parse_header(s, BER_TAG_RESULT, &length);
@@ -103,6 +114,13 @@
 
   ber_parse_header(s, BER_TAG_INTEGER, &length);
   in_uint8s(s, length); /* connect id */
+
+  if (!s_check_rem(s, length)) {
+    rdp_protocol_error("mcs_recv_connect_response(), consume connect id from "
+                       "stream would overrun",
+                       &packet);
+  }
+
   mcs_parse_domain_params(s);
 
   ber_parse_header(s, BER_TAG_OCTET_STRING, &length);
