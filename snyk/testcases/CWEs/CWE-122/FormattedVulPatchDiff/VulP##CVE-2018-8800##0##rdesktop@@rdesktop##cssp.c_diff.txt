--- /home/V1SCAN/CWE-122/FormattedVul/OLD##CVE-2018-8800##0##rdesktop@@rdesktop##cssp.c	2023-12-12 03:51:30.010027062 +0900
+++ /home/V1SCAN/CWE-122/FormattedPatch/NEW##CVE-2018-8800##0##rdesktop@@rdesktop##cssp.c	2023-12-12 03:51:30.300025372 +0900
@@ -556,6 +556,7 @@
   STREAM s;
   int length;
   int tagval;
+  struct stream packet;
 
   s = tcp_recv(NULL, 4);
 
@@ -583,6 +584,7 @@
 
   // receive the remainings of message
   s = tcp_recv(s, length);
+  packet = *s;
 
   // parse the response and into nego token
   if (!ber_in_header(s, &tagval, &length) ||
@@ -593,6 +595,12 @@
   if (!ber_in_header(s, &tagval, &length) ||
       tagval != (BER_TAG_CTXT_SPECIFIC | BER_TAG_CONSTRUCTED | 0))
     return False;
+
+  if (!s_check_rem(s, length)) {
+    rdp_protocol_error(
+        "cssp_read_tsrequest(), consume of version from stream would overrun",
+        &packet);
+  }
   in_uint8s(s, length);
 
   // negoToken [1]
@@ -613,7 +621,14 @@
     if (!ber_in_header(s, &tagval, &length) || tagval != BER_TAG_OCTET_STRING)
       return False;
 
-    token->end = token->p = token->data;
+    if (!s_check_rem(s, length)) {
+      rdp_protocol_error(
+          "cssp_read_tsrequest(), consume of token from stream would overrun",
+          &packet);
+    }
+
+    s_realloc(token, length);
+    s_reset(token);
     out_uint8p(token, s->p, length);
     s_mark_end(token);
   }
