--- /home/V1SCAN/CWE-287/FormattedVul/OLD##CVE-2017-14032##1##ARMmbed@@mbedtls##x509_crt.c	2023-12-12 04:54:11.329941883 +0900
+++ /home/V1SCAN/CWE-287/FormattedPatch/NEW##CVE-2017-14032##1##ARMmbed@@mbedtls##x509_crt.c	2023-12-12 04:54:11.489943283 +0900
@@ -1926,8 +1926,8 @@
 
   /* path_cnt is 0 for the first intermediate CA */
   if (1 + path_cnt > MBEDTLS_X509_MAX_INTERMEDIATE_CA) {
-    *flags |= MBEDTLS_X509_BADCERT_NOT_TRUSTED;
-    return (MBEDTLS_ERR_X509_CERT_VERIFY_FAILED);
+    /* return immediately as the goal is to avoid unbounded recursion */
+    return (MBEDTLS_ERR_X509_FATAL_ERROR);
   }
 
   if (mbedtls_x509_time_is_past(&child->valid_to))
@@ -2137,6 +2137,10 @@
   }
 
 exit:
+  /* prevent misuse of the vrfy callback */
+  if (ret == MBEDTLS_ERR_X509_CERT_VERIFY_FAILED)
+    ret = MBEDTLS_ERR_X509_FATAL_ERROR;
+
   if (ret != 0) {
     *flags = (uint32_t)-1;
     return (ret);
