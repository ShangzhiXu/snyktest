--- /home/V1SCAN/CWE-119/vul/OLD##CVE-2015-7498##0##GNOME@@libxml2##parserInternals.c	2023-11-08 07:54:43.156166400 +0900
+++ /home/V1SCAN/CWE-119/patch/NEW##CVE-2015-7498##0##GNOME@@libxml2##parserInternals.c	2023-11-08 07:54:43.136166412 +0900
@@ -937,6 +937,7 @@
 {
     xmlCharEncodingHandlerPtr handler;
     int len = -1;
+    int ret;
 
     if (ctxt == NULL) return(-1);
     switch (enc) {
@@ -1097,7 +1098,15 @@
     if (handler == NULL)
 	return(-1);
     ctxt->charset = XML_CHAR_ENCODING_UTF8;
-    return(xmlSwitchToEncodingInt(ctxt, handler, len));
+    ret = xmlSwitchToEncodingInt(ctxt, handler, len);
+    if ((ret < 0) || (ctxt->errNo == XML_I18N_CONV_FAILED)) {
+        /*
+	 * on encoding conversion errors, stop the parser
+	 */
+        xmlStopParser(ctxt);
+	ctxt->errNo = XML_I18N_CONV_FAILED;
+    }
+    return(ret);
 }
 
 /**
