--- /home/V1SCAN/CWE-119/FormattedVul/OLD##CVE-2017-16931##0##GNOME@@libxml2##parser.c	2023-12-10 02:44:14.810184876 +0900
+++ /home/V1SCAN/CWE-119/FormattedPatch/NEW##CVE-2017-16931##0##GNOME@@libxml2##parser.c	2023-12-10 02:44:15.500181561 +0900
@@ -2063,8 +2063,6 @@
     } else                                                                     \
       ctxt->input->col++;                                                      \
     ctxt->input->cur += l;                                                     \
-    if (*ctxt->input->cur == '%')                                              \
-      xmlParserHandlePEReference(ctxt);                                        \
   } while (0)
 
 #define CUR_CHAR(l) xmlCurrentChar(ctxt, &l)
@@ -3318,19 +3316,22 @@
       len += l;
       NEXTL(l);
       c = CUR_CHAR(l);
-      if (c == 0) {
-        count = 0;
-        GROW;
-        if (ctxt->instate == XML_PARSER_EOF)
-          return (NULL);
-        c = CUR_CHAR(l);
-      }
     }
   }
   if ((len > XML_MAX_NAME_LENGTH) && ((ctxt->options & XML_PARSE_HUGE) == 0)) {
     xmlFatalErr(ctxt, XML_ERR_NAME_TOO_LONG, "Name");
     return (NULL);
   }
+  if (ctxt->input->cur - ctxt->input->base < len) {
+    /*
+     * There were a couple of bugs where PERefs lead to to a change
+     * of the buffer. Check the buffer size to avoid passing an invalid
+     * pointer to xmlDictLookup.
+     */
+    xmlFatalErr(ctxt, XML_ERR_INTERNAL_ERROR,
+                "unexpected change of input buffer");
+    return (NULL);
+  }
   if ((*ctxt->input->cur == '\n') && (ctxt->input->cur[-1] == '\r'))
     return (xmlDictLookup(ctxt->dict, ctxt->input->cur - (len + 1), len));
   return (xmlDictLookup(ctxt->dict, ctxt->input->cur - len, len));
