--- /home/V1SCAN/CWE-119/FormattedVul/OLD##CVE-2015-7498##0##GNOME@@libxml2##parserInternals.c	2023-12-10 02:44:54.810075162 +0900
+++ /home/V1SCAN/CWE-119/FormattedPatch/NEW##CVE-2015-7498##0##GNOME@@libxml2##parserInternals.c	2023-12-10 02:45:01.520179670 +0900
@@ -926,6 +926,7 @@
 int xmlSwitchEncoding(xmlParserCtxtPtr ctxt, xmlCharEncoding enc) {
   xmlCharEncodingHandlerPtr handler;
   int len = -1;
+  int ret;
 
   if (ctxt == NULL)
     return (-1);
@@ -1079,7 +1080,15 @@
   if (handler == NULL)
     return (-1);
   ctxt->charset = XML_CHAR_ENCODING_UTF8;
-  return (xmlSwitchToEncodingInt(ctxt, handler, len));
+  ret = xmlSwitchToEncodingInt(ctxt, handler, len);
+  if ((ret < 0) || (ctxt->errNo == XML_I18N_CONV_FAILED)) {
+    /*
+     * on encoding conversion errors, stop the parser
+     */
+    xmlStopParser(ctxt);
+    ctxt->errNo = XML_I18N_CONV_FAILED;
+  }
+  return (ret);
 }
 
 /**
