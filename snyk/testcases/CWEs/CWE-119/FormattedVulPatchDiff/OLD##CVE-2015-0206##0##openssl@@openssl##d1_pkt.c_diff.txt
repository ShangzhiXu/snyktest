--- /home/V1SCAN/CWE-119/FormattedVul/OLD##CVE-2015-0206##0##openssl@@openssl##d1_pkt.c	2023-12-10 02:44:54.730074679 +0900
+++ /home/V1SCAN/CWE-119/FormattedPatch/NEW##CVE-2015-0206##0##openssl@@openssl##d1_pkt.c	2023-12-10 02:45:01.440175621 +0900
@@ -255,17 +255,21 @@
 
   if (!ssl3_setup_buffers(s)) {
     SSLerr(SSL_F_DTLS1_BUFFER_RECORD, ERR_R_INTERNAL_ERROR);
+    if (rdata->rbuf.buf != NULL)
+      OPENSSL_free(rdata->rbuf.buf);
     OPENSSL_free(rdata);
     pitem_free(item);
-    return (0);
+    return (-1);
   }
 
   /* insert should not fail, since duplicates are dropped */
   if (pqueue_insert(queue->q, item) == NULL) {
     SSLerr(SSL_F_DTLS1_BUFFER_RECORD, ERR_R_INTERNAL_ERROR);
+    if (rdata->rbuf.buf != NULL)
+      OPENSSL_free(rdata->rbuf.buf);
     OPENSSL_free(rdata);
     pitem_free(item);
-    return (0);
+    return (-1);
   }
 
   return (1);
@@ -311,7 +315,9 @@
       dtls1_get_unprocessed_record(s);
       if (!dtls1_process_record(s))
         return (0);
-      dtls1_buffer_record(s, &(s->d1->processed_rcds), s->s3->rrec.seq_num);
+      if (dtls1_buffer_record(s, &(s->d1->processed_rcds),
+                              s->s3->rrec.seq_num) < 0)
+        return -1;
     }
   }
 
@@ -513,7 +519,6 @@
 
   /* we have pulled in a full packet so zero things */
   s->packet_length = 0;
-  dtls1_record_bitmap_update(s, &(s->d1->bitmap)); /* Mark receipt of record. */
   return (1);
 
 f_err:
@@ -545,7 +550,8 @@
 
   /* The epoch may have changed.  If so, process all the
    * pending records.  This is a non-blocking operation. */
-  dtls1_process_buffered_records(s);dtls1_buffer_record 
+  if (dtls1_process_buffered_records(s) < 0)
+    return -1;
 
   /* if we're renegotiating, then there may be buffered records */
   if (dtls1_get_processed_record(s))
@@ -675,7 +681,9 @@
    */
   if (is_next_epoch) {
     if ((SSL_in_init(s) || s->in_handshake) && !s->d1->listen) {
-      dtls1_buffer_record(s, &(s->d1->unprocessed_rcds), rr->seq_num);
+      if (dtls1_buffer_record(s, &(s->d1->unprocessed_rcds), rr->seq_num) < 0)
+        return -1;
+      dtls1_record_bitmap_update(s, bitmap); /* Mark receipt of record. */
     }
     rr->length = 0;
     s->packet_length = 0;
@@ -687,6 +695,7 @@
     s->packet_length = 0; /* dump this record */
     goto again;           /* get another record */
   }
+  dtls1_record_bitmap_update(s, bitmap); /* Mark receipt of record. */
 
   return (1);
 }
@@ -832,7 +841,10 @@
      * buffer the application data for later processing rather
      * than dropping the connection.
      */
-    dtls1_buffer_record(s, &(s->d1->buffered_app_data), rr->seq_num);
+    if (dtls1_buffer_record(s, &(s->d1->buffered_app_data), rr->seq_num) < 0) {
+      SSLerr(SSL_F_DTLS1_READ_BYTES, ERR_R_INTERNAL_ERROR);
+      return -1;
+    }
     rr->length = 0;
     goto start;
   }
