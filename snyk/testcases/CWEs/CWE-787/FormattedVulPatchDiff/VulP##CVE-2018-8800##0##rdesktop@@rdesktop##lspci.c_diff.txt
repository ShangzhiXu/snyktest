--- /home/V1SCAN/CWE-787/FormattedVul/OLD##CVE-2018-8800##0##rdesktop@@rdesktop##lspci.c	2023-12-06 04:37:17.320325136 +0900
+++ /home/V1SCAN/CWE-787/FormattedPatch/NEW##CVE-2018-8800##0##rdesktop@@rdesktop##lspci.c	2023-12-06 04:37:19.040320926 +0900
@@ -2,6 +2,7 @@
    rdesktop: A Remote Desktop Protocol client.
    Support for the Matrox "lspci" channel
    Copyright (C) 2005 Matrox Graphics Inc.
+   Copyright 2018 Henrik Andersson <hean01@cendio.se> for Cendio AB
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
@@ -105,6 +106,11 @@
   unsigned int pkglen;
   static char *rest = NULL;
   char *buf;
+  struct stream packet = *s;
+
+  if (!s_check(s)) {
+    rdp_protocol_error("lspci_process(), stream is in unstable state", &packet);
+  }
 
   pkglen = s->end - s->p;
   /* str_handle_lines requires null terminated strings */
