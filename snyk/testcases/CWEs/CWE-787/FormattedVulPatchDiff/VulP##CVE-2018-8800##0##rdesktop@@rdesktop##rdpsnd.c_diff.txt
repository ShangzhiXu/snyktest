--- /home/V1SCAN/CWE-787/FormattedVul/OLD##CVE-2018-8800##0##rdesktop@@rdesktop##rdpsnd.c	2023-12-06 04:37:17.420324891 +0900
+++ /home/V1SCAN/CWE-787/FormattedPatch/NEW##CVE-2018-8800##0##rdesktop@@rdesktop##rdpsnd.c	2023-12-06 04:37:19.140320680 +0900
@@ -243,6 +243,13 @@
   uint16 tick;
   uint16 packsize;
   STREAM out;
+  struct stream packet = *in;
+
+  if (!s_check_rem(in, 4)) {
+    rdp_protocol_error("rdpsnd_process_training(), consume of training data "
+                       "from stream would overrun",
+                       &packet);
+  }
 
   in_uint16_le(in, tick);
   in_uint16_le(in, packsize);
@@ -399,6 +406,10 @@
   static char *rest = NULL;
   char *buf;
 
+  if (!s_check(s)) {
+    rdp_protocol_error("rdpsnddbg_process(), stream is in unstable state", s);
+  }
+
   pkglen = s->end - s->p;
   /* str_handle_lines requires null terminated strings */
   buf = (char *)xmalloc(pkglen + 1);
