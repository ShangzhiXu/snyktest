--- /home/V1SCAN/CWE-787/FormattedVul/OLD##CVE-2018-8800##0##rdesktop@@rdesktop##orders.c	2023-12-06 04:37:17.350325060 +0900
+++ /home/V1SCAN/CWE-787/FormattedPatch/NEW##CVE-2018-8800##0##rdesktop@@rdesktop##orders.c	2023-12-06 04:37:19.080320827 +0900
@@ -1173,11 +1173,18 @@
   uint16 flags;
   uint8 type;
   uint8 *next_order;
+  struct stream packet = *s;
 
   in_uint16_le(s, length);
   in_uint16_le(s, flags); /* used by bmpcache2 */
   in_uint8(s, type);
 
+  if (!s_check_rem(s, length + 7)) {
+    rdp_protocol_error(
+        "process_secondary_order(), next order pointer would overrun stream",
+        &packet);
+  }
+
   next_order = s->p + (sint16)length + 7;
 
   switch (type) {
