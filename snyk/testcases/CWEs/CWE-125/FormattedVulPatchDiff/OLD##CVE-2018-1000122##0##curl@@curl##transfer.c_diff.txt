--- /home/V1SCAN/CWE-125/FormattedVul/OLD##CVE-2018-1000122##0##curl@@curl##transfer.c	2023-12-01 06:27:18.116896462 +0900
+++ /home/V1SCAN/CWE-125/FormattedPatch/NEW##CVE-2018-1000122##0##curl@@curl##transfer.c	2023-12-01 06:27:16.915937229 +0900
@@ -774,10 +774,15 @@
 
     } /* if(!header and data to read) */
 
-    if (conn->handler->readwrite &&
-        (excess > 0 && !conn->bits.stream_was_rewound)) {
+    if (conn->handler->readwrite && excess && !conn->bits.stream_was_rewound) {
       /* Parse the excess data */
       k->str += nread;
+
+      if (&k->str[excess] > &k->buf[data->set.buffer_size]) {
+        /* the excess amount was too excessive(!), make sure
+           it doesn't read out of buffer */
+        excess = &k->buf[data->set.buffer_size] - k->str;
+      }
       nread = (ssize_t)excess;
 
       result = conn->handler->readwrite(data, conn, &nread, &readmore);
